name: Deploy to GCP Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  BACKEND_SERVICE_NAME: igcse-pseudocode-backend
  FRONTEND_SERVICE_NAME: igcse-pseudocode-frontend
  BACKEND_DOMAIN: ${{ secrets.BACKEND_DOMAIN }}
  FRONTEND_DOMAIN: ${{ secrets.FRONTEND_DOMAIN }}

jobs:
  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Backend Docker Image
        run: |
          docker build \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-images/${{ env.BACKEND_SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-images/${{ env.BACKEND_SERVICE_NAME }}:latest \
            ./backend

      - name: Push Backend Docker Image
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-images/${{ env.BACKEND_SERVICE_NAME }}:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-images/${{ env.BACKEND_SERVICE_NAME }}:latest

      - name: Deploy Backend to Cloud Run
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE_NAME }} \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-images/${{ env.BACKEND_SERVICE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars 'DEBUG=False' \
            --set-env-vars 'DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}' \
            --set-env-vars 'ALLOWED_HOSTS=${{ env.BACKEND_DOMAIN }}\,${{ env.BACKEND_SERVICE_NAME }}-*-${{ env.GCP_REGION }}.a.run.app' \
            --set-env-vars 'CORS_ALLOWED_ORIGINS=${{ secrets.FRONTEND_URL }}' \
            --min-instances 0 \
            --max-instances 10 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --port 8080

      - name: Get Backend URL
        id: backend-url
        run: |
          URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Backend deployed to: $URL"

      - name: Map Backend Custom Domain (if configured)
        if: env.BACKEND_DOMAIN != ''
        run: |
          gcloud run domain-mappings create \
            --service ${{ env.BACKEND_SERVICE_NAME }} \
            --domain ${{ env.BACKEND_DOMAIN }} \
            --region ${{ env.GCP_REGION }} || echo "Domain mapping already exists or DNS not configured"

    outputs:
      backend_url: ${{ steps.backend-url.outputs.url }}

  deploy-frontend:
    name: Deploy Frontend to Cloud Run
    runs-on: ubuntu-latest
    needs: deploy-backend
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Create frontend .env file for build
        run: |
          echo "VITE_API_BASE_URL=${{ needs.deploy-backend.outputs.backend_url }}" > ./frontend/.env.production

      - name: Build Frontend Docker Image
        run: |
          docker build \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-images/${{ env.FRONTEND_SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-images/${{ env.FRONTEND_SERVICE_NAME }}:latest \
            ./frontend

      - name: Push Frontend Docker Image
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-images/${{ env.FRONTEND_SERVICE_NAME }}:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-images/${{ env.FRONTEND_SERVICE_NAME }}:latest

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE_NAME }} \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-images/${{ env.FRONTEND_SERVICE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances 10 \
            --memory 256Mi \
            --cpu 1 \
            --timeout 300 \
            --port 8080

      - name: Get Frontend URL
        id: frontend-url
        run: |
          URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Frontend deployed to: $URL"

      - name: Map Frontend Custom Domain (if configured)
        if: env.FRONTEND_DOMAIN != ''
        run: |
          gcloud run domain-mappings create \
            --service ${{ env.FRONTEND_SERVICE_NAME }} \
            --domain ${{ env.FRONTEND_DOMAIN }} \
            --region ${{ env.GCP_REGION }} || echo "Domain mapping already exists or DNS not configured"

    outputs:
      frontend_url: ${{ steps.frontend-url.outputs.url }}

  post-deployment:
    name: Post-Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    steps:
      - name: Deployment Summary
        run: |
          echo "ðŸš€ Deployment Successful!"
          echo "================================"
          echo "Backend URL: ${{ needs.deploy-backend.outputs.backend_url }}"
          echo "Frontend URL: ${{ needs.deploy-frontend.outputs.frontend_url }}"
          echo "================================"
          echo "âœ… All services deployed successfully to GCP Cloud Run"
